{% extends "base.html" %}

{% block title %}Wordle - NYT Games Clone{% endblock %}

{% block extra_css %}
<style>
    .wordle-container {
        max-width: 500px;
        margin: 1rem auto;
        padding: 0 1rem;
        text-align: center;
        display: flex;
        flex-direction: column;
        min-height: calc(100vh - 80px);
        justify-content: space-between;
    }

    .game-header {
        margin-bottom: 0.5rem;
    }

    .game-header h1 {
        margin: 0.5rem 0;
        font-size: 1.8rem;
    }

    .game-header p {
        margin: 0.25rem 0;
    }

    .game-stats {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 0.5rem;
    }

    /* Grid Styles */
    .grid {
        display: grid;
        grid-template-rows: repeat(6, 1fr);
        gap: 4px;
        margin: 0.5rem auto;
        width: fit-content;
    }

    .grid-row {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 5px;
    }

    .grid-cell {
        width: 52px;
        height: 52px;
        border: 2px solid #d3d6da;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        font-weight: bold;
        text-transform: uppercase;
        background-color: white;
    }

    .grid-cell.filled {
        border-color: #878a8c;
    }

    .grid-cell.correct {
        background-color: #6ca965;
        border-color: #6ca965;
        color: white;
    }

    .grid-cell.present {
        background-color: #b59f3b;
        border-color: #b59f3b;
        color: white;
    }

    .grid-cell.absent {
        background-color: #787c7f;
        border-color: #787c7f;
        color: #1a1a1a;
    }

    /* Keyboard Styles */
    .keyboard {
        margin: 0.5rem auto 1rem;
        max-width: 500px;
    }

    .keyboard-row {
        display: flex;
        justify-content: center;
        gap: 4px;
        margin-bottom: 4px;
    }

    .key {
        padding: 0.75rem 0.5rem;
        min-width: 38px;
        background-color: #e8f5c8;
        border: 1px solid rgba(138, 186, 24, 0.1);
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        text-transform: uppercase;
        transition: all 0.2s ease;
    }

    .key:hover {
        background-color: #c8e68f;
        border-color: #a8d030;
        transform: translateY(-1px);
    }

    .key.wide {
        min-width: 55px;
        font-size: 0.7rem;
    }

    /* Game Message */
    .game-message {
        margin: 0.5rem 0;
        padding: 0.75rem;
        border-radius: 4px;
        font-weight: bold;
    }

    .game-message.win {
        background: linear-gradient(135deg, #8aba18, #a8d030);
        color: white;
    }

    .game-message.lose {
        background-color: #c8e68f;
        color: #6a9114;
    }

    .game-message.error {
        background-color: #ef476f;
        color: white;
    }

    .hidden {
        display: none;
    }

    #reset-btn {
        padding: 0.8rem 2rem;
        font-size: 1rem;
        margin: 0.25rem auto 1rem;
        display: block;
        max-width: 200px;
    }
</style>
{% endblock %}

{% block content %}
<div class="wordle-container">
    <div class="game-header">
        <h1>Wordle</h1>
        <p>Guess the word in 6 tries</p>
    </div>

    <div class="game-stats">
        <div>Guesses: <span id="guess-count">0</span>/6</div>
    </div>

    <div id="game-message" class="game-message hidden"></div>

    <!-- Game Grid -->
    <div class="grid" id="grid">
        <!-- 6 rows of 5 cells each -->
        <div class="grid-row">
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
        </div>
        <div class="grid-row">
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
        </div>
        <div class="grid-row">
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
        </div>
        <div class="grid-row">
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
        </div>
        <div class="grid-row">
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
        </div>
        <div class="grid-row">
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
        </div>
    </div>

    <!-- On-screen Keyboard -->
    <div class="keyboard">
        <div class="keyboard-row">
            <button class="key" data-key="q">Q</button>
            <button class="key" data-key="w">W</button>
            <button class="key" data-key="e">E</button>
            <button class="key" data-key="r">R</button>
            <button class="key" data-key="t">T</button>
            <button class="key" data-key="y">Y</button>
            <button class="key" data-key="u">U</button>
            <button class="key" data-key="i">I</button>
            <button class="key" data-key="o">O</button>
            <button class="key" data-key="p">P</button>
        </div>
        <div class="keyboard-row">
            <button class="key" data-key="a">A</button>
            <button class="key" data-key="s">S</button>
            <button class="key" data-key="d">D</button>
            <button class="key" data-key="f">F</button>
            <button class="key" data-key="g">G</button>
            <button class="key" data-key="h">H</button>
            <button class="key" data-key="j">J</button>
            <button class="key" data-key="k">K</button>
            <button class="key" data-key="l">L</button>
            <button class="key wide" data-key="enter">Enter</button>
        </div>
        <div class="keyboard-row">
            <button class="key wide" data-key="backspace">âŒ«</button>
            <button class="key" data-key="z">Z</button>
            <button class="key" data-key="x">X</button>
            <button class="key" data-key="c">C</button>
            <button class="key" data-key="v">V</button>
            <button class="key" data-key="b">B</button>
            <button class="key" data-key="n">N</button>
            <button class="key" data-key="m">M</button>
        </div>
    </div>

    <button id="reset-btn" class="btn btn-primary" onclick="resetGame()">New Game</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Game state
    let currentRow = 0;
    let currentGuess = '';
    let gameOver = false;

    // Initialize game on page load
    document.addEventListener('DOMContentLoaded', () => {
        startGame();
        setupEventListeners();
    });

    function startGame() {
        fetch('/wordle/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Game started');
        })
        .catch(error => {
            showMessage('Error starting game', 'error');
            console.error('Error:', error);
        });
    }

    function setupEventListeners() {
        // On-screen keyboard
        document.querySelectorAll('.key').forEach(key => {
            key.addEventListener('click', () => {
                handleKey(key.dataset.key);
            });
        });

        // Physical keyboard
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleKey('enter');
            } else if (e.key === 'Backspace') {
                handleKey('backspace');
            } else if (/^[a-zA-Z]$/.test(e.key)) {
                handleKey(e.key.toLowerCase());
            }
        });
    }

    function handleKey(key) {
        if (gameOver) return;

        if (key === 'enter') {
            submitGuess();
        } else if (key === 'backspace') {
            removeLetter();
        } else if (currentGuess.length < 5) {
            addLetter(key);
        }
    }

    function addLetter(letter) {
        if (currentGuess.length < 5) {
            currentGuess += letter;
            updateDisplay();
        }
    }

    function removeLetter() {
        currentGuess = currentGuess.slice(0, -1);
        updateDisplay();
    }

    function updateDisplay() {
        const row = document.querySelectorAll('.grid-row')[currentRow];
        const cells = row.querySelectorAll('.grid-cell');

        cells.forEach((cell, index) => {
            if (index < currentGuess.length) {
                cell.textContent = currentGuess[index].toUpperCase();
                cell.classList.add('filled');
            } else {
                cell.textContent = '';
                cell.classList.remove('filled');
            }
        });
    }

    function submitGuess() {
        if (currentGuess.length !== 5) {
            showMessage('Word must be 5 letters', 'error');
            return;
        }

        fetch('/wordle/guess', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ guess: currentGuess })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showMessage(data.error, 'error');
                return;
            }

            // Update grid with evaluation
            updateGridWithEvaluation(data.guesses[currentRow]);

            // Update stats
            document.getElementById('guess-count').textContent = data.guess_count;

            // Check win/lose
            if (data.is_won) {
                showMessage('Congratulations! You won!', 'win');
                gameOver = true;
            } else if (data.is_lost) {
                showMessage(`Game Over! The word was: ${data.secret_word.toUpperCase()}`, 'lose');
                gameOver = true;
            } else {
                currentRow++;
                currentGuess = '';
            }
        })
        .catch(error => {
            showMessage('Invalid word or error submitting guess', 'error');
            console.error('Error:', error);
        });
    }

    function updateGridWithEvaluation(guess) {
        const row = document.querySelectorAll('.grid-row')[currentRow];
        const cells = row.querySelectorAll('.grid-cell');

        guess.evaluation.forEach((result, index) => {
            cells[index].textContent = guess.word[index].toUpperCase();  // AnNguyen fixed 12/05 - display letters
            cells[index].classList.remove('filled');
            cells[index].classList.add(result.toLowerCase());
        });
    }

    function showMessage(text, type) {
        const messageEl = document.getElementById('game-message');
        messageEl.textContent = text;
        messageEl.className = `game-message ${type}`;
        messageEl.classList.remove('hidden');

        // Auto-hide after 3 seconds for errors
        if (type === 'error') {
            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 3000);
        }
    }

    // AnNguyen fixed race condition bug on 12/05 - properly chain async reset/start calls
    function resetGame() {
        document.activeElement.blur();  // Remove focus from button to prevent Enter key from retriggering
        fetch('/wordle/reset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(() => {
            // Reset UI state
            currentRow = 0;
            currentGuess = '';
            gameOver = false;

            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.textContent = '';
                cell.className = 'grid-cell';
            });

            document.getElementById('guess-count').textContent = '0';
            document.getElementById('game-message').classList.add('hidden');

            // Start new game after reset completes
            return fetch('/wordle/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
        })
        .then(response => response.json())
        .then(data => {
            console.log('New game started after reset');
        })
        .catch(error => {
            showMessage('Error resetting game', 'error');
            console.error('Error:', error);
        });
    }
</script>
{% endblock %}
